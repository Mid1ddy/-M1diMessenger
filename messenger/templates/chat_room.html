<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Чат с @{{ friend }}</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background:#f0f2f5;
      display:flex; flex-direction:column; height:100vh;
      color:#111;
    }
    header {
      padding:12px 16px;
      background:white;
      border-bottom:1px solid #ddd;
      display:flex; align-items:center; gap:12px;
    }
    .back-btn {
      font-size:24px; color:#65676b; text-decoration:none;
      padding:4px 8px; border-radius:50%;
    }
    .back-btn:hover { background:#e4e6eb; }
    .chat-header h2 { font-size:18px; margin:0; }
    .chat-header .status { font-size:13px; color:#65676b; }
    #messages {
      flex:1; overflow-y:auto; padding:16px;
      display:flex; flex-direction:column; gap:2px;
      background:#e5ddd5 url('') fixed;
      background-size:cover;
    }
    .msg {
      max-width:78%; margin:6px 0; padding:8px 14px;
      border-radius:18px; font-size:15px; line-height:1.35;
      position:relative;
    }
    .msg.me {
      align-self:flex-end;
      background:#0084ff; color:white;
      border-bottom-right-radius:5px;
    }
    .msg.other {
      align-self:flex-start;
      background:white; color:#111;
      border-bottom-left-radius:5px;
    }
    .msg strong { display:block; font-size:13px; opacity:0.9; margin-bottom:3px; }
    #input-area {
      padding:12px 16px; background:white; border-top:1px solid #ddd;
      display:flex; align-items:center; gap:10px;
    }
    #message {
      flex:1; padding:12px 16px; font-size:16px;
      border:1px solid #ccc; border-radius:24px;
      background:#f0f2f5; outline:none;
      resize: none; /* чтобы не тянуть за угол */
      min-height: 44px;
      max-height: 160px;
    }
    #message:focus { border-color:#0084ff; background:white; }
    button {
      width:48px; height:48px; border:none;
      background:#0084ff; color:white; border-radius:50%;
      font-size:20px; cursor:pointer;
    }
    button:hover { background:#0069d9; }
    button:disabled {
      background:#ccc;
      cursor:not-allowed;
    }
  </style>
</head>
<body>

  <header>
    <a href="/chat" class="back-btn">←</a>
    <div class="chat-header">
      <h2>@{{ friend }}</h2>
      <div class="status">в сети</div>
    </div>
  </header>

  <div id="messages">
    {% for msg in messages %}
      <div class="msg {% if msg.from == me %}me{% else %}other{% endif %}">
        {% if msg.from != me %}<strong>{{ msg.from }}</strong>{% endif %}
        {{ msg.text }}
      </div>
    {% endfor %}
  </div>

  <div id="input-area">
    <textarea
      id="message"
      placeholder="Сообщение..."
      autocomplete="off"
      rows="1"
      autofocus
    ></textarea>
    <button onclick="send()">➤</button>
  </div>

<script>
  const socket = io();
  const friend = {{ friend | tojson | safe }};
  const me     = {{ me     | tojson | safe }};

  const messageInput = document.getElementById('message');
  const sendButton = document.querySelector('#input-area button');

  // Авто-растяжка текстового поля
  messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
    sendButton.disabled = !this.value.trim();
  });

  socket.on('new_message', (data) => {
    if (
      (data.from === me     && data.to === friend) ||
      (data.from === friend && data.to === me)
    ) {
      addMessage(data.from, data.text);
    }
  });

  function addMessage(from, text) {
    const container = document.getElementById('messages');
    const msgDiv = document.createElement('div');
    msgDiv.className = `msg ${from === me ? 'me' : 'other'}`;

    let html = '';
    if (from !== me) {
      html += `<strong>${from}</strong>`;
    }
    html += text.replace(/</g, '&lt;').replace(/>/g, '&gt;');

    msgDiv.innerHTML = html;
    container.appendChild(msgDiv);
    msgDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
  }

  function send() {
    const text = messageInput.value.trim();
    if (!text) return;

    socket.emit('message', { to: friend, text });

    messageInput.value = '';
    messageInput.style.height = 'auto';
    sendButton.disabled = true;
    messageInput.focus();
  }

  messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  socket.on('connect', () => console.log('Socket подключён'));
  socket.on('new_message', (data) => console.log('Получено:', data));

  sendButton.disabled = true;
</script>

</body>
</html>